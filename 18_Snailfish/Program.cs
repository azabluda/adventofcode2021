// https://adventofcode.com/2021/day/18
// Day 18: Snailfish

Test.Cases.ForEach(Snailfish);

void Snailfish(string input)
{
    var lines = input.Split(Environment.NewLine);
    var part1 = Magnitude(lines.Aggregate(Sum));
    var part2 = (from s in lines
                 from t in lines
                 where !ReferenceEquals(s, t)
                 select Magnitude(Sum(s, t))).Max();
    Console.WriteLine(input);
    Console.WriteLine($"Part 1: {part1}");
    Console.WriteLine($"Part 2: {part2}");
    Console.WriteLine();
}

string Sum(string s, string t)
{
    const string map = "],[0123456789";
    var res = $"[{s},{t}]".Select(ch => map.IndexOf(ch) - 3).ToList(); // string -> List<int>
    while (Explode(res) || Split(res)); // reduce List<int>
    return string.Concat(res.Select(n => map[n + 3])); // List<int> -> string
}

bool Explode(List<int> res)
{
    // find pair at depth >4
    int i = -1;
    for (int d = 0; d <= 4;)
        if (++i == res.Count) return false;
        else if (res[i] < 0) d += res[i] + 2;
    
    // left shard
    int l = res.FindLastIndex(i, n => n >= 0);
    if (l >= 0) res[l] += res[i + 1];

    // right shard
    int r = res.FindIndex(i + 5, n => n >= 0);
    if (r >= 0) res[r] += res[i + 3];

    // replace pair with integer 0
    res.RemoveRange(i, 5);
    res.Insert(i, 0);
    return true;
}

bool Split(List<int> res)
{
    // find integer >9
    int i = res.FindIndex(n => n > 9);
    if (i < 0) return false;
    int n = res[i];

    // replace it with split pair
    res.RemoveAt(i);
    res.InsertRange(i, new[] { -1, n / 2, -2, ++n / 2, -3 });
    return true;
}

int Magnitude(string s)
{
    s = s.Replace(",", "").Replace("]", "");
    int i = -1;
    int Wtf() => s[++i] == '[' ? 3 * Wtf() + 2 * Wtf() : s[i] - '0';
    return Wtf();
}

static class Test
{
    public static List<string> Cases { get; } = new()
    {
@"[[[[4,3],4],4],[7,[[8,4],9]]]
[1,1]",

@"[[[0,[4,5]],[0,0]],[[[4,5],[2,6]],[9,5]]]
[7,[[[3,7],[4,3]],[[6,3],[8,8]]]]
[[2,[[0,8],[3,4]]],[[[6,7],1],[7,[1,6]]]]
[[[[2,4],7],[6,[0,5]]],[[[6,8],[2,8]],[[2,1],[4,5]]]]
[7,[5,[[3,8],[1,4]]]]
[[2,[2,2]],[8,[8,1]]]
[2,9]
[1,[[[9,3],9],[[9,0],[0,7]]]]
[[[5,[7,4]],7],1]
[[[[4,2],2],6],[8,7]]",

@"[1,2]
[3,4]",

@"[1,1]
[2,2]
[3,3]
[4,4]",

@"[1,1]
[2,2]
[3,3]
[4,4]
[5,5]",

@"[1,1]
[2,2]
[3,3]
[4,4]
[5,5]
[6,6]",

@"[[[0,[5,8]],[[1,7],[9,6]]],[[4,[1,2]],[[1,4],2]]]
[[[5,[2,8]],4],[5,[[9,9],0]]]
[6,[[[6,2],[5,6]],[[7,6],[4,7]]]]
[[[6,[0,7]],[0,9]],[4,[9,[9,0]]]]
[[[7,[6,4]],[3,[1,3]]],[[[5,5],1],9]]
[[6,[[7,3],[3,2]]],[[[3,8],[5,7]],4]]
[[[[5,4],[7,7]],8],[[8,3],8]]
[[9,3],[[9,9],[6,[4,9]]]]
[[2,[[7,7],7]],[[5,8],[[9,3],[0,2]]]]
[[[[5,2],5],[8,[3,7]]],[[5,[7,5]],[4,4]]]",

@"[[3,[8,[2,1]]],[[[0,6],[0,2]],3]]
[[[1,[8,5]],[[3,9],0]],2]
[5,[[5,[3,8]],[7,4]]]
[1,[[[0,4],[8,5]],6]]
[[[1,[0,3]],2],[2,[0,[7,9]]]]
[[[4,[4,4]],[[7,2],[7,1]]],9]
[5,[4,4]]
[[0,[[2,6],[8,9]]],[[4,5],2]]
[[[8,2],0],3]
[[9,0],[3,3]]
[[[[5,2],2],5],5]
[[[1,6],[[0,4],[7,7]]],[[1,4],[[6,5],5]]]
[[[[4,1],[4,1]],[2,[5,5]]],[1,[0,[0,6]]]]
[[[[1,5],1],[8,4]],[9,[3,4]]]
[[1,[3,3]],[[[7,4],[8,1]],2]]
[3,[[[2,1],4],[5,4]]]
[6,[[0,[1,9]],[[4,0],8]]]
[5,[7,[7,[8,8]]]]
[[[[6,2],[5,8]],[5,[3,1]]],[[7,9],[[2,0],6]]]
[[[7,[7,9]],[5,7]],[[[9,3],[6,9]],[[1,2],[2,3]]]]
[[[[4,1],2],[1,[6,6]]],[[[2,2],[8,8]],4]]
[[[[3,7],4],8],[6,[[0,2],3]]]
[[[[1,8],2],3],[[9,[1,7]],[[0,0],[6,8]]]]
[[[9,[5,2]],7],[[8,6],[8,[1,2]]]]
[[[7,[1,0]],[[6,0],[8,4]]],[[[7,8],5],[3,[1,2]]]]
[[[[2,5],9],[[8,2],0]],0]
[0,[[[7,5],[4,1]],[5,[6,6]]]]
[[[[3,6],2],[[1,1],[6,6]]],0]
[[[[0,9],[2,5]],[2,[3,2]]],[6,3]]
[3,[[9,[1,4]],[[0,8],[4,6]]]]
[1,[[5,[5,9]],[9,0]]]
[[[6,8],4],[[[6,6],2],[[3,9],2]]]
[5,[[[7,5],[4,8]],0]]
[[9,[6,6]],[9,[[6,8],[6,4]]]]
[[[4,8],[0,[2,8]]],[7,[[4,5],[1,6]]]]
[[[6,[8,6]],2],[[[2,9],[2,4]],[0,2]]]
[[[0,[5,6]],[[3,8],3]],[[3,1],7]]
[[1,[8,1]],[1,[6,[7,1]]]]
[[[5,[9,6]],[3,5]],2]
[[3,7],[[[2,5],[4,1]],[3,[5,6]]]]
[[8,7],[[9,6],3]]
[[[[4,2],[4,8]],[7,[4,5]]],2]
[[[[6,7],6],3],[[[6,7],4],0]]
[[[0,1],[[9,1],[2,9]]],9]
[[[[8,5],[5,8]],[0,7]],[0,[8,[3,2]]]]
[[4,[[6,5],[1,9]]],[[[0,0],1],6]]
[[[[9,5],9],[2,[6,3]]],[[2,9],[6,9]]]
[[[7,[5,0]],1],[7,[[8,7],3]]]
[[[2,4],2],[[[3,0],6],[[0,2],[9,2]]]]
[[1,[[7,3],[4,3]]],[[[3,9],[1,1]],[3,6]]]
[[[[4,7],7],[[7,1],[2,3]]],[1,[[7,6],[5,6]]]]
[[0,[5,2]],0]
[[[[6,6],[4,8]],8],[[0,[7,4]],8]]
[[4,[7,2]],[[[0,8],1],[9,5]]]
[0,0]
[[[[3,7],6],3],[3,[[3,3],1]]]
[[[6,5],7],[[3,5],[[6,4],[4,9]]]]
[[4,[[7,9],9]],9]
[5,[8,[[7,4],1]]]
[[[[2,4],[5,7]],8],[[[7,6],[6,9]],[[3,9],[6,4]]]]
[[[4,8],3],[[[3,9],7],0]]
[0,[8,[[4,2],3]]]
[[[[0,1],[5,8]],[7,2]],[2,4]]
[[6,[8,[1,9]]],[[[6,5],[8,1]],[7,[6,4]]]]
[[9,3],[5,[0,6]]]
[[2,[7,[2,0]]],[[2,1],[5,5]]]
[[[0,[7,0]],[[0,4],[4,9]]],[8,[[6,1],[6,3]]]]
[[[[5,7],[3,2]],[0,[5,0]]],[[0,[1,6]],3]]
[[[[6,3],[9,5]],[9,9]],[[5,[8,3]],[[0,0],[0,3]]]]
[[6,[4,9]],[[[9,9],[8,4]],4]]
[0,[2,5]]
[[[[7,9],[1,2]],[3,3]],[[[7,2],7],[[1,6],0]]]
[[[[8,0],2],8],[[[1,5],9],9]]
[[[0,[6,9]],4],[[[4,8],5],4]]
[[6,[[0,3],4]],[0,[[8,3],1]]]
[[[1,2],[2,[3,3]]],[6,7]]
[[0,[[7,4],5]],[3,[[8,2],0]]]
[[[[0,1],[1,7]],[[2,7],[5,9]]],[[[7,0],0],[8,1]]]
[[6,4],[3,0]]
[[[[6,6],4],[5,1]],[7,3]]
[[[[9,2],3],[8,[4,8]]],7]
[[5,[[2,2],[9,2]]],[[[1,8],0],[8,[6,3]]]]
[2,[[0,0],[0,[9,9]]]]
[[4,4],[[6,5],[6,5]]]
[[[[9,1],2],4],5]
[[[[2,1],[3,1]],[[2,6],9]],5]
[[[9,[0,6]],7],[[8,3],[[8,1],2]]]
[[[6,[0,0]],[2,[0,0]]],[[[0,4],8],3]]
[[[[4,1],[2,9]],[6,5]],3]
[[9,[[9,4],8]],[[[5,5],3],[[3,4],4]]]
[8,[9,[[0,3],1]]]
[9,[[[6,0],4],9]]
[[6,[2,9]],[[[2,7],[5,3]],0]]
[[[4,1],5],[8,[[0,7],4]]]
[[[[2,5],5],[[8,2],[8,9]]],[[9,6],[[0,3],[2,3]]]]
[6,1]
[[1,7],4]
[[8,7],0]
[[[[5,4],7],5],[[[6,1],5],[5,[5,5]]]]
[[[6,[1,5]],[0,[7,0]]],[[[1,5],3],[5,[1,0]]]]",
    };
}